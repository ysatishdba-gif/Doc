# %% [25] Pre-relevance vs post-relevance comparison
# Pre-relevance = term-free stages only (ontology + embeddings)
# Post-relevance = after token boost + Otsu (term-dependent)
for result in results:
    pre = result.pre_relevance_retention
    post = result.retention
    removed_by_relevance = set(e.cui for e in pre) - set(e.cui for e in post)

    log(f"\n{'=' * 60}")
    log(f"PRE vs POST RELEVANCE FILTER")
    log(f"  Pre-relevance (term-free):     {len(pre)} CUIs")
    log(f"  Post-relevance (term-dependent): {len(post)} CUIs")
    log(f"  Removed by relevance filter:   {len(removed_by_relevance)} CUIs")

    # top 20 pre-relevance CUIs (same as post — these are the most aligned)
    log(f"\n-- Top 20 pre-relevance CUIs --")
    for entry in pre[:20]:
        stys = ", ".join(entry.semantic_types[:2]) if entry.semantic_types else "?"
        marker = "✓" if entry.cui not in removed_by_relevance else "✗"
        log(f"  {marker} {entry.cui} | align={entry.alignment} | [{stys}] {entry.term}")

    # bottom 20 pre-relevance CUIs (these are the least aligned that survived stages 1-6)
    log(f"\n-- Bottom 20 pre-relevance CUIs --")
    for entry in pre[-20:]:
        stys = ", ".join(entry.semantic_types[:2]) if entry.semantic_types else "?"
        marker = "✓" if entry.cui not in removed_by_relevance else "✗"
        log(f"  {marker} {entry.cui} | align={entry.alignment} | [{stys}] {entry.term}")

    # export pre-relevance to CSV for leadership review
    import csv
    csv_path = f"/tmp/pre_relevance_cuis_{len(pre)}.csv"
    with open(csv_path, "w", newline="") as f:
        w = csv.writer(f)
        w.writerow(["CUI", "Preferred_Term", "Alignment", "Semantic_Types",
                     "Kept_By_Relevance", "Explains_Count"])
        for entry in pre:
            w.writerow([
                entry.cui,
                entry.term,
                f"{entry.alignment:.4f}",
                "; ".join(entry.semantic_types) if entry.semantic_types else "",
                "YES" if entry.cui not in removed_by_relevance else "NO",
                len(entry.explains_cuis) if entry.explains_cuis else 0
            ])
    log(f"\n  Exported to: {csv_path}")
