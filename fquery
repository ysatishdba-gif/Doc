import json
import re
from datetime import datetime
from google.cloud import aiplatform
from vertexai.generative_models import GenerativeModel


# ======================================================
# STRICT JSON ENFORCEMENT
# ======================================================

STRICT_JSON = """
STRICT OUTPUT REQUIREMENTS:
- Output VALID JSON ONLY.
- First character MUST be '{' and last MUST be '}'.
- No commentary, no explanations, no markdown.
"""


# ======================================================
# PROMPT 1 — EXPANSION (Only One Prompt)
# ======================================================

EXPANSION_PROMPT = """
SYSTEM:
You are a medical linguistic expansion engine.

TASK:
Transform the user's input into a fully explicit, unambiguous, and
detailed clinical description.

GENERAL RULES:
- Expand every vague, shorthand, implicit, grouped, or abstract reference
  into explicit, concrete clinical meaning.
- Expand all category-level references (e.g., "labs", "vitals",
  "family history", "gynec history", etc.) into fully described,
  contextually meaningful explanations.
- Preserve the user's intended meaning WITHOUT adding new facts.
- Do NOT provide medical advice or interpretation.
- Produce one coherent expanded clinical narrative.

RETURN JSON ONLY:
{
  "expanded_query": "string"
}

User Input: "{query}"
""" + STRICT_JSON



# ======================================================
# PROMPT 2 — INTENTION EXTRACTION (Only One Prompt)
# ======================================================

INTENTION_PROMPT = """
SYSTEM:
You are a clinical intention extraction engine.

TASK:
Convert the expanded clinical narrative into a structured set of
intents representing the user's underlying goals, implicit requests,
and described clinical themes.

RULES:
- Derive intents ONLY from the expanded narrative.
- For each intent, create:
  - intent_title: short descriptive title
  - description: brief explanation of what the intent means
  - nature: a high-level category you create dynamically
  - sub_nature: further subdivisions you define (no predefined lists)
  - final_queries: atomic queries derived from that intent
- Do NOT add information not present or implied.
- Do NOT provide medical advice.

RETURN JSON ONLY:
{
  "original_query": "{expanded}",
  "expanded_query": "{expanded}",
  "intents": [
    {
      "intent_title": "string",
      "description": "string",
      "nature": "string",
      "sub_nature": [
        {
          "category": "string",
          "elements": ["string"],
          "entities": ["string"]
        }
      ],
      "final_queries": ["string"]
    }
  ]
}

Timestamp: "{timestamp}"
""" + STRICT_JSON



# ======================================================
# JSON EXTRACTOR
# ======================================================

def extract_largest_json(text):
    matches = re.findall(r'\{(?:[^{}]|(?R))*\}', text, flags=re.DOTALL)
    for block in sorted(matches, key=len, reverse=True):
        try:
            return json.loads(block)
        except:
            continue
    return {}


# ======================================================
# TWO-PROMPT PIPELINE
# ======================================================

class TwoPromptPipeline:

    def __init__(self, project, location="us-central1", model="gemini-2.0-flash"):
        aiplatform.init(project=project, location=location)
        self.model = GenerativeModel(model)

    def _call(self, prompt):
        if hasattr(self.model, "session") and self.model.session:
            self.model.session.reset()
        result = self.model.generate_content(
            prompt,
            generation_config={
                "temperature": 0.0,
                "top_p": 1.0,
                "max_output_tokens": 8192
            }
        )
        return result.text.strip()

    # --------------------------------------------------

    def expand(self, query):
        raw = self._call(EXPANSION_PROMPT.format(query=query))
        data = extract_largest_json(raw)
        return data.get("expanded_query", query)

    # --------------------------------------------------

    def intents(self, expanded):
        raw = self._call(
            INTENTION_PROMPT.format(
                expanded=expanded,
                timestamp=datetime.utcnow().isoformat()
            )
        )
        data = extract_largest_json(raw)
        return data.get("intents", [])

    # --------------------------------------------------

    def run(self, query):
        expanded = self.expand(query)
        return {
            "original_query": query,
            "expanded_query": expanded,
            "intents": self.intents(expanded)
        }


# ======================================================
# USAGE EXAMPLE
# ======================================================

if __name__ == "__main__":
    PROJECT_ID = "YOUR_PROJECT_ID"

    pipeline = TwoPromptPipeline(project=PROJECT_ID)

    query = "Patient wants labs, vitals, family history, gynic reviewed."

    result = pipeline.run(query)
    print(json.dumps(result, indent=2))
