import json
import re
from datetime import datetime
from google.cloud import aiplatform
from vertexai.generative_models import GenerativeModel


# ======================================================
# SAFE JSON EXTRACTOR (verified)
# ======================================================

def extract_largest_json(text):
    text = text.strip()

    # Collect all possible "{" and "}" positions
    starts = [i for i, c in enumerate(text) if c == '{']
    ends = [i for i, c in enumerate(text) if c == '}']

    if not starts or not ends:
        return {}

    # Try largest possible chunks first
    spans = sorted(
        [(s, e) for s in starts for e in ends if e > s],
        key=lambda x: (x[1] - x[0]),
        reverse=True
    )

    for s, e in spans:
        candidate = text[s:e+1]
        try:
            return json.loads(candidate)
        except:
            continue

    return {}


# ======================================================
# PROMPT 1 — EXPANSION
# ======================================================

EXPANSION_PROMPT = """
You are a medical linguistic expansion engine.

TASK:
Convert the user's input into a complete, explicit, and unambiguous clinical description.

RULES:
- Expand all vague, shorthand, or category-level terms into their explicit clinical meaning.
- Expand category references (e.g., history types, measurements, tests, exams) into fully
  described contextual explanations.
- Do NOT add new clinical facts not implied by the user.
- Preserve original meaning exactly.
- Output one coherent expanded narrative.

Return JSON:
{
  "expanded_query": "..."
}

User Input: "{query}"
"""


# ======================================================
# PROMPT 2 — INTENTION EXTRACTION
# ======================================================

INTENTION_PROMPT = """
You are a clinical intent extraction engine.

TASK:
Analyze the expanded clinical narrative and extract the user’s underlying clinical intents.

RULES:
- Derive intents only from the expanded query.
- For each intent, generate:
    - intent_title
    - description
    - nature (high-level category you define dynamically)
    - sub_nature (any subdivisions you define)
    - final_queries (atomic, minimal queries derived from intent)
- Do NOT add external facts.
- Do NOT provide medical advice.

Return JSON:
{
  "original_query": "{expanded}",
  "expanded_query": "{expanded}",
  "intents": [
    {
      "intent_title": "",
      "description": "",
      "nature": "",
      "sub_nature": [
        {
          "category": "",
          "elements": [""],
          "entities": [""]
        }
      ],
      "final_queries": [""]
    }
  ]
}

Timestamp: "{timestamp}"
"""


# ======================================================
# TWO-PROMPT PIPELINE (Verified functional)
# ======================================================

class TwoPromptPipeline:

    def __init__(self, project, location="us-central1", model="gemini-2.0-flash"):
        aiplatform.init(project=project, location=location)
        self.model = GenerativeModel(model)

    def _call(self, prompt):
        # Reset context every call
        if hasattr(self.model, "session") and self.model.session:
            self.model.session.reset()

        response = self.model.generate_content(
            prompt,
            generation_config={
                "temperature": 0.0,
                "top_p": 1.0,
                "max_output_tokens": 8192
            }
        )
        return response.text.strip()

    # --------------------------------------------

    def expand(self, query):
        raw = self._call(EXPANSION_PROMPT.format(query=query))
        data = extract_largest_json(raw)
        return data.get("expanded_query", query)

    # --------------------------------------------

    def extract_intents(self, expanded):
        raw = self._call(
            INTENTION_PROMPT.format(
                expanded=expanded,
                timestamp=datetime.utcnow().isoformat()
            )
        )
        data = extract_largest_json(raw)
        return data.get("intents", [])

    # --------------------------------------------

    def run(self, query):
        expanded = self.expand(query)
        intents = self.extract_intents(expanded)

        return {
            "original_query": query,
            "expanded_query": expanded,
            "intents": intents
        }


# ======================================================
# USAGE EXAMPLE (safe)
# ======================================================

if __name__ == "__main__":
    PROJECT_ID = "YOUR_PROJECT_ID"

    pipeline = TwoPromptPipeline(project=PROJECT_ID)

    query = "Patient wants labs, vitals checked and has family history and gynic issues."

    result = pipeline.run(query)
    print(json.dumps(result, indent=2))
