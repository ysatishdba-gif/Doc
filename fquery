import json
import re
from datetime import datetime
from google.cloud import aiplatform
from vertexai.generative_models import GenerativeModel

# ======================================================
# SAFE JSON EXTRACTOR
# ======================================================
def extract_largest_json(text):
    text = text.strip()
    starts = [i for i, c in enumerate(text) if c == '{']
    ends = [i for i, c in enumerate(text) if c == '}']

    if not starts or not ends:
        return {}

    spans = sorted(
        [(s, e) for s in starts for e in ends if e > s],
        key=lambda x: (x[1] - x[0]),
        reverse=True
    )

    for s, e in spans:
        candidate = text[s:e+1]
        try:
            return json.loads(candidate)
        except:
            continue

    return {}

# ======================================================
# PROMPT 1 — CLAUSE-AWARE GENERALIZED EXPANSION
# ======================================================
EXPANSION_PROMPT = """
You are a medical linguistic expansion engine.

TASK:
Convert the user's input into a fully explicit, detailed clinical description.

RULES:
1. Split the input into distinct clauses or statements.
2. For each clause:
   - Expand all vague, ambiguous, or abbreviated terms into unambiguous clinical language.
   - Expand any category-level references (history, tests, measurements, symptoms, observations, clinical findings, exposures, medications, procedures, or any other clinical domain) into clear, detailed descriptions.
   - Preserve relationships and context (e.g., family member → condition, symptom → location/severity).
   - Maintain all details present in the original input.
3. Do NOT hallucinate or add information not implied by the input.
4. Produce one coherent expanded narrative combining all clauses.

Return JSON:
{
  "expanded_query": "..."
}

User Input: "{query}"
"""

# ======================================================
# PROMPT 2 — INTENTION EXTRACTION
# ======================================================
INTENTION_PROMPT = """
You are a clinical intent extraction engine.

TASK:
Analyze the expanded clinical narrative and extract the user's underlying clinical intents.

RULES:
- Derive intents only from the expanded query.
- For each intent, generate:
    - intent_title
    - description
    - nature (high-level category you define dynamically)
    - sub_nature (any subdivisions you define)
    - final_queries (atomic, minimal queries derived from intent)
- Do NOT add external facts.
- Do NOT provide medical advice.

Return JSON:
{
  "original_query": "{expanded}",
  "expanded_query": "{expanded}",
  "intents": [
    {
      "intent_title": "",
      "description": "",
      "nature": "",
      "sub_nature": [
        {
          "category": "",
          "elements": [""],
          "entities": [""]
        }
      ],
      "final_queries": [""]
    }
  ]
}

Timestamp: "{timestamp}"
"""

# ======================================================
# TWO-PROMPT PIPELINE
# ======================================================
class TwoPromptPipeline:

    def __init__(self, project, location="us-central1", model="gemini-2.0-flash"):
        aiplatform.init(project=project, location=location)
        self.model = GenerativeModel(model)

    def _call(self, prompt):
        if hasattr(self.model, "session") and self.model.session:
            self.model.session.reset()

        result = self.model.generate_content(
            prompt,
            generation_config={
                "temperature": 0.0,
                "top_p": 1.0,
                "max_output_tokens": 8192
            }
        )
        return result.text.strip()

    # --------------------------------------------------
    def expand(self, query):
        raw = self._call(EXPANSION_PROMPT.format(query=query))
        data = extract_largest_json(raw)
        return data.get("expanded_query", query)

    # --------------------------------------------------
    def extract_intents(self, expanded):
        raw = self._call(
            INTENTION_PROMPT.format(
                expanded=expanded,
                timestamp=datetime.utcnow().isoformat()
            )
        )
        data = extract_largest_json(raw)
        return data.get("intents", [])

    # --------------------------------------------------
    def run(self, query):
        expanded = self.expand(query)
        intents = self.extract_intents(expanded)

        return {
            "original_query": query,
            "expanded_query": expanded,
            "intents": intents
        }

# ======================================================
# USAGE EXAMPLE
# ======================================================
if __name__ == "__main__":
    PROJECT_ID = "YOUR_PROJECT_ID"

    pipeline = TwoPromptPipeline(project=PROJECT_ID)

    query = (
        "The patient has a family history of diabetes and heart disease. "
        "They want their lab results reviewed. "
        "They also report fatigue, chest pain, and shortness of breath."
    )

    result = pipeline.run(query)
    print(json.dumps(result, indent=2))
