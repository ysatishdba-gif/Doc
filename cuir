# %% Why is embedding reduction only removing 36?
from collections import Counter

reasons = Counter()
for entry in result.audit_trail:
    reasons[entry.reason] += 1

print("Audit breakdown:")
for reason, count in reasons.most_common():
    print(f"  {reason}: {count}")

# check how many pairs terms_diverge blocks
sample_cuis = result.all_reduced_cuis[:200]
diverge_count = 0
same_type_count = 0
for i in range(len(sample_cuis)):
    a_meta = metadata.get(sample_cuis[i])
    if not a_meta:
        continue
    for j in range(i+1, len(sample_cuis)):
        b_meta = metadata.get(sample_cuis[j])
        if not b_meta:
            continue
        a_types = set(a_meta.semantic_types)
        b_types = set(b_meta.semantic_types)
        if a_types & b_types:
            same_type_count += 1
            if terms_diverge(a_meta.term_tokens, b_meta.term_tokens):
                diverge_count += 1

print(f"\nSame-type pairs checked: {same_type_count}")
print(f"Blocked by terms_diverge: {diverge_count} ({diverge_count/max(same_type_count,1):.0%})")
