# %% Extract hierarchy — SINGLE PASS over edges, O(50M)
import re
import networkx as nx
import pickle

suffix_pattern = re.compile(r'^(C\d{5,})-\d+$')
cui_pattern = re.compile(r'^C\d{5,}$')

# Step 1: Map every suffix node to its base CUI
# C0150874-0 → C0150874
print("Step 1: Building suffix → base CUI map...")
suffix_to_cui = {}
for node in obj.nodes():
    if isinstance(node, str):
        m = suffix_pattern.match(node)
        if m:
            suffix_to_cui[node] = m.group(1)

print(f"  Suffix nodes mapped: {len(suffix_to_cui)}")

# Step 2: Single pass over ALL edges
# If suffix-A → suffix-B, that means base(A) → base(B)
print("Step 2: Scanning edges...")
edges = set()
count = 0
for u, v in obj.edges():
    base_u = suffix_to_cui.get(u)
    base_v = suffix_to_cui.get(v)
    
    if base_u and base_v and base_u != base_v:
        edges.add((base_u, base_v))
    
    count += 1
    if count % 10_000_000 == 0:
        print(f"  {count}/{obj.number_of_edges()} edges scanned, "
              f"{len(edges)} CUI pairs found")

print(f"\nStep 3: Building hierarchy graph...")
hierarchy = nx.DiGraph()
hierarchy.add_edges_from(edges)

print(f"Hierarchy extracted:")
print(f"  Nodes: {hierarchy.number_of_nodes()}")
print(f"  Edges: {hierarchy.number_of_edges()}")

# Validate
sample = list(hierarchy.nodes())[:5]
for node in sample:
    parents = list(hierarchy.predecessors(node))[:3]
    children = list(hierarchy.successors(node))[:3]
    print(f"  {node}: parents={parents}, children={children}")

with open("umls_hierarchy.pkl", "wb") as f:
    pickle.dump(hierarchy, f)
print(f"Saved: umls_hierarchy.pkl")
