# %% Check SABs — self-contained, no dependencies
import pickle
from google.cloud import bigquery

PROJECT_ID = "your-project-id"      # ← your actual values
DATASET_ID = "your-dataset"

bq = bigquery.Client(project=PROJECT_ID)

# Paste your raw CUIs here (before SAB filter)
cuis = ["C0030193", "C0028081"]  # ← paste your actual CUI list

query = f"""
SELECT CUI, ARRAY_AGG(DISTINCT SAB) AS sabs
FROM `{PROJECT_ID}.{DATASET_ID}.MRCONSO`
WHERE CUI IN UNNEST(@cuis) AND LAT = 'ENG'
GROUP BY CUI
"""
jc = bigquery.QueryJobConfig(query_parameters=[
    bigquery.ArrayQueryParameter("cuis", "STRING", cuis)
])

sab_counts = {}
for row in bq.query(query, job_config=jc).result():
    for sab in row.sabs:
        sab_counts[sab] = sab_counts.get(sab, 0) + 1

print(f"CUIs checked: {len(cuis)}")
print(f"\nSABs in your CUIs:")
for sab, count in sorted(sab_counts.items(), key=lambda x: -x[1]):
    print(f"  {sab}: {count}")

print(f"\nYour allowed: ICD10CM, ICD10PCS, ICD9CM, SNOMEDCT_US, LOINC")
