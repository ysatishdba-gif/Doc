# %% IC scores on real hierarchy â€” run ONCE
import pickle
import numpy as np
from collections import deque

with open("umls_hierarchy.pkl", "rb") as f:
    hierarchy = pickle.load(f)

total = max(hierarchy.number_of_nodes(), 1)
print(f"Computing IC for {total} nodes...")

ic_scores = {}
for i, node in enumerate(hierarchy.nodes()):
    visited = set()
    q = deque([node])
    while q:
        n = q.popleft()
        for child in hierarchy.successors(n):
            if child not in visited:
                visited.add(child)
                q.append(child)
    ic_scores[node] = float(-np.log((len(visited) + 1) / total))
    
    if (i + 1) % 100_000 == 0:
        print(f"  {i+1}/{total} done")

print(f"Done. {len(ic_scores)} IC scores")
with open("ic_precomputed.pkl", "wb") as f:
    pickle.dump(ic_scores, f)
print("Saved: ic_precomputed.pkl")



with open("umls_hierarchy.pkl", "rb") as f:
    hierarchy = pickle.load(f)
with open("ic_precomputed.pkl", "rb") as f:
    ic_precomputed = pickle.load(f)

system = CUIReductionSystem(
    PROJECT_ID, DATASET_ID,
    hierarchy,
    ALLOWED_SABS,
    EMBEDDING_TABLE,
    ic_scores=ic_precomputed,
)

result = system.reduce(cuis, "your text")
