# %% [Cell 1] Precompute IC scores — run ONCE, takes ~10-15 min for 2.3M nodes
import pickle
import numpy as np
import networkx as nx
import logging
from collections import deque

logging.basicConfig(level=logging.INFO, format="%(asctime)s %(message)s")
log = logging.getLogger("ic_precompute")

NETWORK_PATH = "networkx_cui_context_v1_1_0.pkl"
OUTPUT_PATH = "ic_precomputed.pkl"

log.info("Loading hierarchy...")
with open(NETWORK_PATH, "rb") as f:
    network = pickle.load(f)

total = max(network.number_of_nodes(), 1)
log.info(f"Graph: {total} nodes, {network.number_of_edges()} edges")

ic_scores = {}
nodes = list(network.nodes())

for i, node in enumerate(nodes):
    # BFS to count descendants
    visited = set()
    q = deque([node])
    while q:
        n = q.popleft()
        for child in network.successors(n):
            if child not in visited:
                visited.add(child)
                q.append(child)
    ic_scores[node] = float(-np.log((len(visited) + 1) / total))

    if (i + 1) % 100_000 == 0:
        log.info(f"  {i + 1}/{total} nodes processed")

log.info(f"Done. {len(ic_scores)} IC scores computed")
log.info(f"Saving to {OUTPUT_PATH}...")
with open(OUTPUT_PATH, "wb") as f:
    pickle.dump(ic_scores, f)
log.info(f"Saved. File ready for runtime use.")


# %% [Cell 2] Use precomputed IC at runtime — loads in <1 second
import pickle

IC_PATH = "ic_precomputed.pkl"
NETWORK_PATH = "networkx_cui_context_v1_1_0.pkl"

with open(NETWORK_PATH, "rb") as f:
    network = pickle.load(f)

with open(IC_PATH, "rb") as f:
    ic_precomputed = pickle.load(f)

# Pass ic_scores — ICComputer does dict lookup, zero BFS
system = CUIReductionSystem(
    project_id="your-project-id",
    dataset_id="your-dataset",
    full_network=network,
    allowed_sabs=["ICD10CM", "ICD10PCS", "ICD9CM", "SNOMEDCT_US", "LOINC"],
    embedding_table="cui_embeddings",
    ic_scores=ic_precomputed,  # <-- this skips all BFS
)
